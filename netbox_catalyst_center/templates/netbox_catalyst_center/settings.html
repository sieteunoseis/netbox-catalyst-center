{% extends 'generic/object.html' %}
{% load form_helpers %}

{% block title %}Catalyst Center Settings{% endblock %}

{% block header %}
<div class="d-flex justify-content-between align-items-center">
    <h1><i class="mdi mdi-cog"></i> Catalyst Center Settings</h1>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-server-network"></i> Current Configuration
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <tr>
                        <th style="width: 200px;">Catalyst Center URL</th>
                        <td>
                            {% if config.catalyst_center_url %}
                            <code>{{ config.catalyst_center_url }}</code>
                            {% else %}
                            <span class="text-danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Username</th>
                        <td>
                            {% if config.catalyst_center_username %}
                            <code>{{ config.catalyst_center_username }}</code>
                            {% else %}
                            <span class="text-danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Password</th>
                        <td>
                            {% if config.catalyst_center_password %}
                            <span class="text-success">********</span>
                            {% else %}
                            <span class="text-danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Timeout</th>
                        <td>{{ config.timeout|default:30 }} seconds</td>
                    </tr>
                    <tr>
                        <th>Cache Timeout</th>
                        <td>{{ config.cache_timeout|default:60 }} seconds</td>
                    </tr>
                    <tr>
                        <th>Verify SSL</th>
                        <td>
                            {% if config.verify_ssl %}
                            <span class="badge bg-success text-white">Enabled</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">Disabled</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>

                <!-- Device Mappings -->
                <h6 class="mt-4 mb-3"><i class="mdi mdi-map"></i> Device Mappings</h6>
                {% if config.device_mappings %}
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Manufacturer</th>
                            <th>Device Type</th>
                            <th>Lookup Method</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in config.device_mappings %}
                        <tr>
                            <td><code>{{ mapping.manufacturer|default:"*" }}</code></td>
                            <td><code>{{ mapping.device_type|default:"*" }}</code></td>
                            <td>
                                {% if mapping.lookup == "client" or mapping.lookup == "mac" %}
                                <span class="badge bg-info text-dark">Client</span>
                                <small class="text-muted">(MAC lookup via Client API)</small>
                                {% else %}
                                <span class="badge bg-primary text-white">Network Device</span>
                                <small class="text-muted">(IP &rarr; Hostname &rarr; All devices)</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-warning">
                    <i class="mdi mdi-alert"></i> No device mappings configured. The Catalyst Center tab will not appear on any devices.
                </div>
                {% endif %}

                <!-- Test Connection Button -->
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" id="test-connection-btn">
                        <i class="mdi mdi-play"></i> Test Connection
                    </button>
                    <div id="test-result" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Device Search & Import -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-magnify"></i> Search & Import Devices from Catalyst Center
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Search for devices in Catalyst Center and import them to NetBox.
                    Use <code>*</code> as a wildcard (e.g., <code>ADM*</code> or <code>10.77.*</code>).
                </p>

                <!-- Search Form -->
                <div class="row g-2 mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="search-type">
                            <option value="hostname">Hostname</option>
                            <option value="ip">IP Address</option>
                            <option value="mac">MAC Address</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-value"
                               placeholder="Enter search term (e.g., ADM* or 10.77.*)">
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary w-100" id="search-btn">
                            <i class="mdi mdi-magnify"></i> Search
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="search-results" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="result-count" class="text-muted"></span>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-btn">
                                Select All New
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-btn">
                                Deselect All
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="results-table">
                            <thead class="sticky-top bg-body">
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="select-all-checkbox"></th>
                                    <th>Hostname</th>
                                    <th>Management IP</th>
                                    <th>Platform</th>
                                    <th>Serial</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="results-body">
                            </tbody>
                        </table>
                    </div>

                    <!-- Import Options -->
                    <div class="card mt-3 bg-body-secondary">
                        <div class="card-body">
                            <h6 class="card-title">Import Options</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Default Site <span class="text-danger">*</span></label>
                                    <select class="form-select" id="import-site" required>
                                        <option value="">Select a site...</option>
                                        {% for site in sites %}
                                        <option value="{{ site.pk }}">{{ site.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Device Role (optional)</label>
                                    <select class="form-select" id="import-role">
                                        <option value="">Auto-detect from DNAC</option>
                                        {% for role in roles %}
                                        <option value="{{ role.pk }}">{{ role.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-success" id="import-btn" disabled>
                                    <i class="mdi mdi-import"></i> Import Selected Devices
                                </button>
                                <span id="selected-count" class="ms-2 text-muted">0 devices selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Import Results -->
                    <div id="import-results" class="mt-3" style="display: none;"></div>
                </div>

                <!-- Loading indicator -->
                <div id="search-loading" style="display: none;" class="text-center py-4">
                    <i class="mdi mdi-loading mdi-spin mdi-48px"></i>
                    <p class="mt-2">Searching Catalyst Center...</p>
                </div>
            </div>
        </div>

        <!-- Configuration Help -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-help-circle"></i> Configuration Help
                </h5>
            </div>
            <div class="card-body">
                <p>Add to <code>configuration.py</code>:</p>
                <pre class="bg-body-secondary p-2 rounded" style="font-size: 0.8rem;"><code>PLUGINS = ['netbox_catalyst_center']

PLUGINS_CONFIG = {
    'netbox_catalyst_center': {
        'catalyst_center_url': 'https://dnac.example.com',
        'catalyst_center_username': 'api-user',
        'catalyst_center_password': 'your-password',
        'timeout': 30,
        'cache_timeout': 60,
        'verify_ssl': False,
        # Device mappings control which devices show the tab
        # manufacturer/device_type are regex patterns
        # lookup types:
        #   "network_device" - IP > hostname > fetch all (for Cisco infra)
        #   "client" - MAC address only (for wireless clients)
        'device_mappings': [
            {'manufacturer': 'cisco', 'lookup': 'network_device'},
            {'manufacturer': 'vocera', 'lookup': 'client'},
        ],
    }
}</code></pre>
                <a href="https://github.com/sieteunoseis/netbox-catalyst-center" target="_blank" class="btn btn-outline-secondary btn-sm">
                    <i class="mdi mdi-github"></i> View Documentation
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-information"></i> About
                </h5>
            </div>
            <div class="card-body">
                <p>
                    This plugin displays Cisco Catalyst Center (formerly DNA Center)
                    data on Device pages in NetBox.
                </p>
                <p>
                    <strong>Network Devices</strong> (hostname lookup):
                </p>
                <ul>
                    <li>Reachability status</li>
                    <li>Software version &amp; platform</li>
                    <li>Serial number &amp; uptime</li>
                    <li>SNMP location/contact</li>
                </ul>
                <p>
                    <strong>Wireless Clients</strong> (MAC lookup):
                </p>
                <ul>
                    <li>Connection status &amp; health score</li>
                    <li>Connected AP/switch info</li>
                    <li>Signal quality (RSSI, SNR)</li>
                    <li>SSID and VLAN details</li>
                </ul>
                <p class="text-muted small mb-0">
                    Version 1.0.0
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Test Connection
document.getElementById('test-connection-btn').addEventListener('click', function() {
    var btn = this;
    var resultDiv = document.getElementById('test-result');

    btn.disabled = true;
    btn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Testing...';
    resultDiv.innerHTML = '';

    fetch('{% url "plugins:netbox_catalyst_center:test_connection" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success"><i class="mdi mdi-check-circle"></i> ' + data.message + '</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="mdi mdi-alert-circle"></i> ' + data.error + '</div>';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="mdi mdi-alert-circle"></i> Request failed: ' + error + '</div>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="mdi mdi-play"></i> Test Connection';
    });
});

// Device Search & Import
var searchResults = [];

// Search button
document.getElementById('search-btn').addEventListener('click', function() {
    var searchType = document.getElementById('search-type').value;
    var searchValue = document.getElementById('search-value').value.trim();

    if (!searchValue) {
        alert('Please enter a search term');
        return;
    }

    // Show loading
    document.getElementById('search-loading').style.display = 'block';
    document.getElementById('search-results').style.display = 'none';

    var url = '{% url "plugins:netbox_catalyst_center:search_devices" %}?search_type=' + encodeURIComponent(searchType) + '&search_value=' + encodeURIComponent(searchValue);

    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('search-loading').style.display = 'none';

        if (data.error) {
            alert('Search error: ' + data.error);
            return;
        }

        searchResults = data.devices || [];
        renderSearchResults(searchResults, data.total_in_dnac);
        document.getElementById('search-results').style.display = 'block';
    })
    .catch(error => {
        document.getElementById('search-loading').style.display = 'none';
        alert('Search failed: ' + error);
    });
});

// Allow Enter key in search box
document.getElementById('search-value').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('search-btn').click();
    }
});

function renderSearchResults(devices, totalInDnac) {
    var tbody = document.getElementById('results-body');
    tbody.innerHTML = '';

    document.getElementById('result-count').textContent =
        devices.length + ' devices found (out of ' + totalInDnac + ' total in Catalyst Center)';

    devices.forEach(function(device, index) {
        var row = document.createElement('tr');
        if (device.exists_in_netbox) {
            row.classList.add('table-secondary');
        }

        var checkbox = device.exists_in_netbox
            ? '<input type="checkbox" disabled title="Already exists in NetBox">'
            : '<input type="checkbox" class="device-checkbox" data-index="' + index + '">';

        var statusBadge = device.exists_in_netbox
            ? '<a href="' + device.netbox_device_url + '" class="badge bg-success text-white">In NetBox</a>'
            : '<span class="badge bg-warning text-dark">New</span>';

        var reachability = device.reachability_status === 'Reachable'
            ? '<i class="mdi mdi-check-circle text-success" title="Reachable"></i>'
            : '<i class="mdi mdi-alert-circle text-warning" title="' + (device.reachability_status || 'Unknown') + '"></i>';

        row.innerHTML =
            '<td>' + checkbox + '</td>' +
            '<td>' + (device.hostname || 'N/A') + ' ' + reachability + '</td>' +
            '<td><code>' + (device.management_ip || 'N/A') + '</code></td>' +
            '<td><small>' + (device.platform || device.device_family || 'N/A') + '</small></td>' +
            '<td><small>' + (device.serial_number || 'N/A') + '</small></td>' +
            '<td>' + statusBadge + '</td>';

        tbody.appendChild(row);
    });

    updateSelectedCount();
}

// Checkbox handlers
document.getElementById('results-body').addEventListener('change', function(e) {
    if (e.target.classList.contains('device-checkbox')) {
        updateSelectedCount();
    }
});

document.getElementById('select-all-checkbox').addEventListener('change', function() {
    var checked = this.checked;
    document.querySelectorAll('.device-checkbox').forEach(function(cb) {
        cb.checked = checked;
    });
    updateSelectedCount();
});

document.getElementById('select-all-btn').addEventListener('click', function() {
    document.querySelectorAll('.device-checkbox').forEach(function(cb) {
        cb.checked = true;
    });
    document.getElementById('select-all-checkbox').checked = true;
    updateSelectedCount();
});

document.getElementById('deselect-all-btn').addEventListener('click', function() {
    document.querySelectorAll('.device-checkbox').forEach(function(cb) {
        cb.checked = false;
    });
    document.getElementById('select-all-checkbox').checked = false;
    updateSelectedCount();
});

function updateSelectedCount() {
    var count = document.querySelectorAll('.device-checkbox:checked').length;
    document.getElementById('selected-count').textContent = count + ' device(s) selected';
    document.getElementById('import-btn').disabled = count === 0;
}

// Import button
document.getElementById('import-btn').addEventListener('click', function() {
    var siteId = document.getElementById('import-site').value;
    if (!siteId) {
        alert('Please select a default site');
        return;
    }

    var selectedDevices = [];
    document.querySelectorAll('.device-checkbox:checked').forEach(function(cb) {
        var index = parseInt(cb.getAttribute('data-index'));
        selectedDevices.push(searchResults[index]);
    });

    if (selectedDevices.length === 0) {
        alert('Please select at least one device');
        return;
    }

    if (!confirm('Import ' + selectedDevices.length + ' device(s) to NetBox?')) {
        return;
    }

    var btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Importing...';

    var roleId = document.getElementById('import-role').value;

    fetch('{% url "plugins:netbox_catalyst_center:import_devices" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            devices: selectedDevices,
            default_site_id: parseInt(siteId),
            default_role_id: roleId ? parseInt(roleId) : null
        })
    })
    .then(response => response.json())
    .then(data => {
        var resultsDiv = document.getElementById('import-results');
        resultsDiv.style.display = 'block';

        if (data.error) {
            resultsDiv.innerHTML = '<div class="alert alert-danger"><i class="mdi mdi-alert-circle"></i> ' + data.error + '</div>';
        } else {
            var html = '<div class="alert alert-success">' +
                '<strong><i class="mdi mdi-check-circle"></i> Import Complete</strong><br>' +
                'Created: ' + data.created_count + ', Skipped: ' + data.skipped_count + ', Errors: ' + data.error_count +
                '</div>';

            if (data.results.created.length > 0) {
                html += '<div class="mb-2"><strong>Created:</strong></div><ul class="list-unstyled">';
                data.results.created.forEach(function(d) {
                    html += '<li><i class="mdi mdi-check text-success"></i> <a href="/dcim/devices/' + d.netbox_id + '/">' + d.hostname + '</a> (' + d.device_type + ')</li>';
                });
                html += '</ul>';
            }

            if (data.results.skipped.length > 0) {
                html += '<div class="mb-2"><strong>Skipped:</strong></div><ul class="list-unstyled">';
                data.results.skipped.forEach(function(d) {
                    html += '<li><i class="mdi mdi-skip-next text-warning"></i> ' + d.hostname + ' - ' + d.reason + '</li>';
                });
                html += '</ul>';
            }

            if (data.results.errors.length > 0) {
                html += '<div class="mb-2"><strong>Errors:</strong></div><ul class="list-unstyled">';
                data.results.errors.forEach(function(d) {
                    html += '<li><i class="mdi mdi-alert text-danger"></i> ' + d.hostname + ' - ' + d.error + '</li>';
                });
                html += '</ul>';
            }

            resultsDiv.innerHTML = html;

            // Refresh search to update "exists" status
            document.getElementById('search-btn').click();
        }
    })
    .catch(error => {
        document.getElementById('import-results').innerHTML =
            '<div class="alert alert-danger"><i class="mdi mdi-alert-circle"></i> Import failed: ' + error + '</div>';
        document.getElementById('import-results').style.display = 'block';
    })
    .finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="mdi mdi-import"></i> Import Selected Devices';
        updateSelectedCount();
    });
});
</script>
{% endblock %}
